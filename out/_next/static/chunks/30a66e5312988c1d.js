(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,6085,e=>{"use strict";var t="undefined"!=typeof self?self:"undefined"!=typeof window?window:e.g;let a=t.fetch,s=t.fetch.bind(t),l=t.Headers,i=t.Request,n=t.Response;e.s(["Headers",0,l,"Request",0,i,"Response",0,n,"default",0,s,"fetch",0,a])},70902,e=>{"use strict";var t=e.i(43476),a=e.i(71645),s=e.i(65464);function l(e){let t=new Date,a=[],s=[],l=[];for(let i of e)i.is_coupon?i.expires_at&&new Date(i.expires_at)<t?l.push(i):a.push(i):s.push(i);return a.sort((e,t)=>(e.expires_at?new Date(e.expires_at).getTime():Number.MAX_SAFE_INTEGER)-(t.expires_at?new Date(t.expires_at).getTime():Number.MAX_SAFE_INTEGER)||new Date(t.created_at)-new Date(e.created_at)),s.sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)),l.sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)),[...a,...s,...l]}function i(){let[e,i]=(0,a.useState)(null),[n,r]=(0,a.useState)([]),[o,c]=(0,a.useState)(!0),[d,p]=(0,a.useState)(null),[u,x]=(0,a.useState)({title:"",body:"",tags:"",is_coupon:!1,expires_at:"",imageFile:null,image_url:""});async function m(){c(!0);let{data:e,error:t}=await s.supabase.from("posts").select("*").order("created_at",{ascending:!1}).limit(200);t||r(e||[]),c(!1)}function h(){p(null),x({title:"",body:"",tags:"",is_coupon:!1,expires_at:"",imageFile:null,image_url:""})}async function g(e){if(!e)return null;let{data:{user:t}}=await s.supabase.auth.getUser();if(!t)throw Error("You are signed out. Please log in again.");let a=e.name.split(".").pop()?.toLowerCase()||"jpg",l=`${crypto.randomUUID()}.${a}`,{error:i}=await s.supabase.storage.from("news").upload(l,e,{cacheControl:"3600",upsert:!1,contentType:e.type||"image/jpeg"});if(i)throw i;let{data:n}=s.supabase.storage.from("news").getPublicUrl(l);return n?.publicUrl||null}function b(e,t){let a=new Set,s=[],l=e=>{let t=e.trim();if(!t)return;let l=t.toLowerCase();a.has(l)||(a.add(l),s.push(t[0].toUpperCase()+t.slice(1)))};return(e||"").split(",").forEach(e=>l(e)),t&&l("Coupon"),s}async function f(e){e.preventDefault();let{data:{user:t}}=await s.supabase.auth.getUser();if(!t){alert("Please sign in again."),location.href="/admin/login";return}try{let e=u.image_url||null;u.imageFile&&(e=await g(u.imageFile));let t=b(u.tags,u.is_coupon),{error:a}=await s.supabase.from("posts").insert({title:u.title.trim(),body:u.body.trim(),image_url:e,is_coupon:!!u.is_coupon,expires_at:u.expires_at?new Date(u.expires_at).toISOString():null,tags:t});if(a)throw a;h(),m()}catch(e){alert(e.message||"Failed to create")}}async function j(e){e.preventDefault();let{data:{user:t}}=await s.supabase.auth.getUser();if(!t){alert("Please sign in again."),location.href="/admin/login";return}try{let e=u.image_url||d?.image_url||null;u.imageFile&&(e=await g(u.imageFile));let t=b(u.tags,u.is_coupon),{error:a}=await s.supabase.from("posts").update({title:u.title.trim(),body:u.body.trim(),image_url:e,is_coupon:!!u.is_coupon,expires_at:u.expires_at?new Date(u.expires_at).toISOString():null,tags:t}).eq("id",d.id);if(a)throw a;h(),m()}catch(e){alert(e.message||"Failed to update")}}async function _(e){if(!confirm("Delete this post?"))return;let{error:t}=await s.supabase.from("posts").delete().eq("id",e);t||m()}return((0,a.useEffect)(()=>{s.supabase.auth.getUser().then(({data:e})=>i(e.user||null))},[]),(0,a.useEffect)(()=>{m()},[]),(0,a.useMemo)(()=>l(n),[n]),e)?(0,t.jsxs)("main",{className:"max-w-5xl mx-auto px-4 py-10",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold",children:"Posts / Coupons"}),(0,t.jsx)("button",{className:"btn btn-ghost",onClick:async()=>{await s.supabase.auth.signOut(),location.href="/admin/login"},children:"Sign out"})]}),(0,t.jsxs)("section",{className:"rounded-xl border border-white/10 bg-white dark:bg-gray-900 p-5 mb-10",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold mb-4",children:d?"Edit Post":"Create New"}),(0,t.jsxs)("form",{onSubmit:d?j:f,className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("label",{className:"block",children:[(0,t.jsx)("span",{className:"text-sm",children:"Title *"}),(0,t.jsx)("input",{className:"w-full border rounded px-3 py-2",required:!0,value:u.title,onChange:e=>x({...u,title:e.target.value})})]}),(0,t.jsxs)("label",{className:"block md:col-span-2",children:[(0,t.jsx)("span",{className:"text-sm",children:"Body"}),(0,t.jsx)("textarea",{className:"w-full border rounded px-3 py-2 h-28",value:u.body,onChange:e=>x({...u,body:e.target.value})})]}),(0,t.jsxs)("label",{className:"block",children:[(0,t.jsx)("span",{className:"text-sm",children:"Image (optional)"}),(0,t.jsx)("input",{type:"file",accept:"image/*",onChange:e=>x({...u,imageFile:e.target.files?.[0]||null})})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("input",{id:"is_coupon",type:"checkbox",checked:u.is_coupon,onChange:e=>x({...u,is_coupon:e.target.checked})}),(0,t.jsx)("label",{htmlFor:"is_coupon",children:"This is a coupon"})]}),(0,t.jsxs)("label",{className:"block",children:[(0,t.jsx)("span",{className:"text-sm",children:"Expires At (optional)"}),(0,t.jsx)("input",{type:"datetime-local",className:"border rounded px-3 py-2 w-full",value:u.expires_at,onChange:e=>x({...u,expires_at:e.target.value})})]}),(0,t.jsxs)("label",{className:"block md:col-span-2",children:[(0,t.jsx)("span",{className:"text-sm",children:"Tags (comma-separated)"}),(0,t.jsx)("input",{className:"w-full border rounded px-3 py-2",placeholder:"Announcement, Event, Coupon",value:u.tags,onChange:e=>x({...u,tags:e.target.value})}),!!u.is_coupon&&(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Tip: “Coupon” will be added automatically."})]}),(0,t.jsxs)("div",{className:"md:col-span-2 flex gap-3",children:[(0,t.jsx)("button",{className:"btn btn-primary",type:"submit",children:d?"Save Changes":"Publish"}),d&&(0,t.jsx)("button",{className:"btn btn-ghost",type:"button",onClick:h,children:"Cancel"})]})]})]}),(0,t.jsxs)("section",{className:"rounded-xl border border-white/10 bg-white dark:bg-gray-900 p-5",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Recent Posts"}),o?(0,t.jsx)("p",{children:"Loading…"}):(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"w-full text-left border-separate border-spacing-y-2",children:[(0,t.jsx)("thead",{className:"text-sm text-gray-500",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"px-3",children:"Title"}),(0,t.jsx)("th",{className:"px-3",children:"Type"}),(0,t.jsx)("th",{className:"px-3",children:"Tags"}),(0,t.jsx)("th",{className:"px-3 whitespace-nowrap",children:"Expires"}),(0,t.jsx)("th",{className:"px-3 whitespace-nowrap",children:"Created"}),(0,t.jsx)("th",{className:"px-3",children:"Actions"})]})}),(0,t.jsxs)("tbody",{children:[(0,a.useMemo)(()=>l(n),[n]).map(e=>{let a=e.is_coupon&&e.expires_at&&new Date(e.expires_at)<new Date;return(0,t.jsxs)("tr",{className:"align-top",children:[(0,t.jsx)("td",{className:"px-3 font-medium",children:e.title}),(0,t.jsx)("td",{className:"px-3",children:e.is_coupon?(0,t.jsx)("span",{className:`text-xs px-2 py-1 rounded ${a?"bg-gray-300 text-gray-700":"bg-green-200 text-green-900"}`,children:a?"Coupon (Expired)":"Coupon"}):(0,t.jsx)("span",{className:"text-xs px-2 py-1 rounded bg-blue-200 text-blue-900",children:"Post"})}),(0,t.jsx)("td",{className:"px-3 text-sm",children:[...e.tags||[],...a?["Coupon (Expired)"]:[]].join(", ")||"—"}),(0,t.jsx)("td",{className:"px-3 text-sm",children:e.is_coupon&&e.expires_at?new Date(e.expires_at).toLocaleString():"—"}),(0,t.jsx)("td",{className:"px-3 text-sm",children:new Date(e.created_at).toLocaleString()}),(0,t.jsx)("td",{className:"px-3",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{className:"text-primary underline underline-offset-4",onClick:()=>{p(e),x({title:e.title||"",body:e.body||"",image_url:e.image_url||"",imageFile:null,is_coupon:!!e.is_coupon,expires_at:e.expires_at?new Date(e.expires_at).toISOString().slice(0,16):"",tags:(e.tags||[]).join(", ")})},children:"Edit"}),(0,t.jsx)("button",{className:"text-red-600 underline underline-offset-4",onClick:()=>_(e.id),children:"Delete"})]})})]},e.id)}),!n.length&&(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:6,className:"px-3 py-6 text-center text-gray-500",children:"No posts yet."})})]})]})})]})]}):(0,t.jsxs)("main",{className:"max-w-xl mx-auto px-4 py-10",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"Admin"}),(0,t.jsxs)("p",{children:["You must be signed in. ",(0,t.jsx)("a",{href:"/admin/login",className:"text-primary underline",children:"Go to login"})]})]})}e.s(["default",()=>i])},11737,e=>{e.v(e=>Promise.resolve().then(()=>e(6085)))}]);